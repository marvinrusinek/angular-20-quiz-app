@let qa = combinedQuestionData$ | async;

<ng-container>
  @if (qa && qa.options && qa.options.length > 0) {
    <div class="animation-shell">
      <div class="anim-host" [@changeRoute]="currentQuestionIndex">
        <div class="quiz-card-wrapper">
          <mat-card class="quiz-card">
            <codelab-quiz-header />

            <mat-card-content>
              <codelab-scoreboard />

              <ng-content></ng-content>

              <codelab-quiz-content
                [questionIndex]="currentQuestionIndex"
                [questionToDisplay$]="questionToDisplay$"
                [explanationToDisplay]="explanationToDisplay"
                [displayState$]="displayState$" />

              <codelab-quiz-question
                [questionPayload]="qa"
                [question]="qa.question"
                [options]="qa.options"
                [explanation]="qa.explanation ?? ''"
                [currentQuestionIndex]="currentQuestionIndex"
                [displayState$]="displayState$"
                [shouldRenderOptions]="shouldRenderOptions"
                [questionToDisplay$]="questionToDisplay$"
                [explanationToDisplay]="explanationToDisplay"
                (events)="handleQuizQuestionEvent($event)" />
            </mat-card-content>

            <!-- Scroll Indicator -->
            @if (showScrollIndicator) {
              <div class="scroll-indicator" (click)="scrollToBottom()">
                <i class="material-icons">keyboard_arrow_down</i>
              </div>
            }

            <mat-card-footer [ngClass]="cardFooterClass">
              <!-- Row 1: Selection Message (left) + Navigation (right) -->
              <section class="footer-row-1">
                <div class="message-area">
                  @if (selectionMessage$ | async; as message) {
                    <span class="instructions-message">{{ message }}</span>
                  }
                </div>

                @if (showPaging) {
                  <div class="nav-buttons">
                    @if (shouldShowPrevButton) {
                      <button type="button" class="nav-btn" (click)="advanceToPreviousQuestion()"
                        matTooltip="¬´ Previous Question" matTooltipPosition="above" aria-label="Previous Question">
                        <i class="material-icons">navigate_before</i>
                      </button>
                    }

                    @if (shouldShowRestartButton) {
                      <button type="button" class="nav-btn restart-btn" (click)="restartQuiz()" matTooltip="Restart Quiz"
                        matTooltipPosition="above" aria-label="Restart Quiz">
                        <i class="material-icons">replay</i>
                      </button>
                    }

                    @if (shouldShowNextButton) {
                      <button type="button" class="nav-btn" #nextButton="matTooltip"
                        [disabled]="!(nextButtonEnabled$ | async)" (click)="advanceToNextQuestion()"
                        [matTooltip]="nextButtonTooltip$ | async" matTooltipPosition="above" aria-label="Next Question">
                        <i class="material-icons">navigate_next</i>
                      </button>
                    }
                  </div>
                }
              </section>

              <!-- Show Results Button (when applicable) -->
              @if (shouldShowResultsButton) {
                <section class="show-results-section">
                  <button type="submit" (click)="advanceToResults()" class="show-results-btn" aria-label="Show Results">
                    <i class="material-icons">score</i>
                    <strong>Show Results</strong>
                  </button>
                </section>
              }

              <!-- Row 2: Pagination Dots (center) + Progress (right) -->
              <section class="footer-row-2">
                <div class="paging-dots">
                  @for (q of questions$ | async; track $index) {
                    <div class="dot" [ngClass]="getDotClass($index)" [class.disabled]="!isDotClickable($index)"
                      (click)="navigateToDot($index)" [attr.aria-label]="'Go to question ' + ($index + 1)">
                    </div>
                  }
                </div>
                <span class="progress-inline">({{ progress }}% complete)</span>
              </section>
            </mat-card-footer>
          </mat-card>
        </div>
      </div>
    </div>
  } @else {
    <p>Loading&hellip;</p>
  }

  <!-- VISUAL DEBUGGER FOR TIMER -->
  <div style="position: fixed; top: 60px; right: 10px; z-index: 99999; background: rgba(0,0,0,0.85); color: #0f0; padding: 10px; font-family: monospace; border: 1px solid #0f0; border-radius: 4px; font-size: 12px;">
    <strong>üîç DEBUG Q{{ currentQuestionIndex + 1 }}</strong><br>
    Index: {{ currentQuestionIndex }}<br>
    <hr style="border-color: #333">
    Timer Run: <strong [style.color]="timerService.isTimerRunning ? '#0f0' : '#f00'">{{ timerService.isTimerRunning }}</strong><br>
    Elapsed (prop): {{ timerService.elapsedTime }}<br>
    Elapsed (obs): {{ timerService.elapsedTime$ | async }}s<br>
    Interval ID: {{ timerService.intervalId ? 'EXISTS' : 'NULL' }}<br>
    <hr style="border-color: #333">
    IsAnswered: <strong [style.color]="(quizStateService.isAnswered$ | async) ? '#f00' : '#0f0'">{{ quizStateService.isAnswered$ | async }}</strong><br>
    
    <button (click)="forceResetCurrentQuestion()" style="margin-top: 5px; background: #f00; color: #fff; border: none; padding: 4px; border-radius: 3px; cursor: pointer;">
      FORCE RESET
    </button>
    
    <hr style="border-color: #ff0; margin: 8px 0;">
    <strong style="color: #ff0;">‚ò¢Ô∏è BACKUP TIMER: {{ q6BackupTimer }}s</strong><br>
    <button (click)="startQ6BackupTimer()" style="margin-top: 5px; background: #0f0; color: #000; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-weight: bold;">
      START BACKUP TIMER
    </button>
  </div>
</ng-container>