@let qa = combinedQuestionData$ | async;

<ng-container>
  @if (qa) {
  <div class="animation-shell">
    <div class="anim-host" [@changeRoute]="currentQuestionIndex">
      <div class="quiz-card-wrapper">
        <mat-card class="quiz-card">
          <codelab-quiz-header />

          <mat-card-content>
            <codelab-scoreboard />

            <ng-content></ng-content>

            <codelab-quiz-content 
              [questionToDisplay$]="questionToDisplay$"
              [questionIndex]="currentQuestionIndex"
              [explanationToDisplay]="explanationToDisplay"
              [displayState$]="displayState$" />

            <codelab-quiz-question
              [questionPayload]="qa"
              [question]="qa.question"
              [currentQuestionIndex]="currentQuestionIndex"
              [options]="qa.options"
              [explanation]="qa.explanation"
              [displayState$]="displayState$"
              [shouldRenderOptions]="shouldRenderOptions"
              [questionToDisplay$]="questionToDisplay$"
              [explanationToDisplay]="explanationToDisplay"
              (answer)="selectedAnswer($event)"
              (optionSelected)="onOptionSelected($event)"
              (selectionMessageChange)="
                  onSelectionMessageChange($event)"
              (explanationToDisplayChange)="onExplanationChanged($event)"
              (showExplanationChange)="onShowExplanationChanged($event)" />
          </mat-card-content>

          <mat-card-footer [ngClass]="cardFooterClass">
            @if (selectionMessage$ | async; as message) {
              <h5 class="instructions-message">{{ message }}</h5>
            }

            <!-- NAVIGATION -->
            @if (showPaging) {
              <section class="paging">
                <mat-card-actions>
                  @if (shouldShowPrevButton) {
                    <div class="prev-question-nav">
                      <button type="button" (click)="advanceToPreviousQuestion()" matTooltip="« Previous Question"
                        matTooltipPosition="above" aria-label="Previous Question">
                        <i class="material-icons">navigate_before</i>
                      </button>
                    </div>
                  }

                  @if (shouldShowRestartButton) {
                    <div class="restart-nav">
                      <button type="button" (click)="restartQuiz()" matTooltip="Restart Quiz" matTooltipPosition="above"
                        aria-label="Restart Quiz">
                        <i class="material-icons">replay</i>
                      </button>
                    </div>
                  }

                  @if (shouldShowNextButton) {
                    <div class="next-question-nav">
                      <button type="button" #nextButton="matTooltip" [disabled]="!(nextButtonEnabled$ | async)"
                        (click)="advanceToNextQuestion()" matTooltip="Next Question »" matTooltipPosition="above"
                        [matTooltip]="nextButtonTooltip$ | async" aria-label="Next Question">
                        <i class="material-icons">navigate_next</i>
                      </button>
                    </div>
                  }

                  @if (shouldShowResultsButton) {
                    <div class="show-score-nav">
                      <button type="submit" (click)="advanceToResults()" class="btn btn-outline-primary"
                        aria-label="Show Results">
                        <i class="material-icons">score</i>&nbsp;&nbsp;
                        <strong>Show Results</strong>
                      </button>
                    </div>
                  }
                </mat-card-actions>
              </section>
            }

            <!-- Progress Bar -->
            <!-- Pagination Dots (Replaces Progress Bar) -->
            <section class="paging-dots">
              @for (q of questions$ | async; track $index) {
                <div 
                  class="dot" 
                  [ngClass]="getDotClass($index)"
                  (click)="navigateToDot($index)" 
                  [attr.aria-label]="'Go to question ' + ($index + 1)">
                </div>
              }
            </section>
          </mat-card-footer>
        </mat-card>
      </div>
    </div>
  </div>
  } @else {
  <p>Loading…</p>
  }
</ng-container>